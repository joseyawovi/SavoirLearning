{% extends 'base.html' %}
{% load i18n %}

{% block title %}{{ room.title }} - Savoir+{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<div class="mb-6">
    <nav class="flex items-center space-x-2 text-sm">
        <a href="{% url 'dashboard' %}" class="text-gray-400 hover:text-primary transition-colors">
            <i class="fas fa-home mr-1"></i>{% trans "Dashboard" %}
        </a>
        <i class="fas fa-chevron-right text-gray-600"></i>
        <a href="{% url 'roadmap_detail' room.roadmap.id %}" class="text-gray-400 hover:text-primary transition-colors">
            {{ room.roadmap.title }}
        </a>
        <i class="fas fa-chevron-right text-gray-600"></i>
        <span class="text-white">{{ room.title }}</span>
    </nav>
</div>

<!-- Room Header -->
<div class="bg-dark-card border border-dark-border rounded-xl p-6 mb-8">
    <div class="flex items-center justify-between">
        <div class="flex items-center">
            <div class="w-16 h-16 bg-primary rounded-xl flex items-center justify-center mr-6">
                <i class="fas fa-door-open text-white text-2xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">{{ room.title }}</h1>
                <p class="text-gray-400 text-lg">{{ room.description }}</p>
                <div class="flex items-center mt-3 space-x-4">
                    <div class="flex items-center text-sm text-gray-300">
                        <i class="fas fa-book-open mr-1 text-primary"></i>
                        {{ sections.count }} {% trans "Sections" %}
                    </div>
                    <div class="flex items-center text-sm text-gray-300">
                        <i class="fas fa-brain mr-1 text-primary"></i>
                        {{ total_questions }} {% trans "Questions" %}
                    </div>
                    {% if room.prerequisite_room %}
                    <div class="flex items-center text-sm text-gray-300">
                        <i class="fas fa-arrow-left mr-1 text-primary"></i>
                        {% trans "Requires" %}: {{ room.prerequisite_room.title }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="text-right">
            <div class="mb-2">
                <span class="text-2xl font-bold text-white">{{ room_progress }}%</span>
            </div>
            <div class="w-32 h-3 bg-dark-bg rounded-full">
                <div class="h-3 bg-primary rounded-full transition-all duration-500" style="width: {{ room_progress }}%"></div>
            </div>
            <p class="text-xs text-gray-400 mt-1">{% trans "Room Progress" %}</p>
        </div>
    </div>
</div>

<!-- Room Stats -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-dark-card border border-dark-border rounded-xl p-6">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center mr-4">
                <i class="fas fa-list text-white text-xl"></i>
            </div>
            <div>
                <p class="text-gray-400 text-sm">{% trans "Total Sections" %}</p>
                <p class="text-2xl font-bold text-white">{{ sections.count }}</p>
            </div>
        </div>
    </div>

    <div class="bg-dark-card border border-dark-border rounded-xl p-6">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center mr-4">
                <i class="fas fa-check-circle text-white text-xl"></i>
            </div>
            <div>
                <p class="text-gray-400 text-sm">{% trans "Completed" %}</p>
                <p class="text-2xl font-bold text-white">{{ completed_sections }}</p>
            </div>
        </div>
    </div>

    <div class="bg-dark-card border border-dark-border rounded-xl p-6">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-yellow-600 rounded-lg flex items-center justify-center mr-4">
                <i class="fas fa-brain text-white text-xl"></i>
            </div>
            <div>
                <p class="text-gray-400 text-sm">{% trans "Quiz Questions" %}</p>
                <p class="text-2xl font-bold text-white">{{ total_questions }}</p>
            </div>
        </div>
    </div>

    <div class="bg-dark-card border border-dark-border rounded-xl p-6">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center mr-4">
                <i class="fas fa-graduation-cap text-white text-xl"></i>
            </div>
            <div>
                <p class="text-gray-400 text-sm">{% trans "Final Exam" %}</p>
                <p class="text-lg font-bold text-white">
                    {% if room_completion.is_completed %}
                        {% trans "Passed" %}
                    {% elif all_sections_completed %}
                        {% trans "Available" %}
                    {% else %}
                        {% trans "Locked" %}
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Sections List -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-white">
            <i class="fas fa-list text-primary mr-2"></i>
            {% trans "Course Sections" %}
        </h2>
        <div class="text-sm text-gray-400">
            <i class="fas fa-info-circle mr-1"></i>
            Complete sections in order
        </div>
    </div>

    {% if sections_data %}
    <div class="space-y-4">
        {% for section_data in sections_data %}
        <div class="bg-dark-card border border-dark-border rounded-xl p-6 {% if section_data.is_accessible %}hover:border-primary{% endif %} transition-all duration-300 group">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 {% if section_data.is_completed %}bg-success{% elif section_data.is_accessible %}bg-primary{% else %}bg-gray-600{% endif %} rounded-lg flex items-center justify-center mr-4 {% if section_data.is_accessible %}group-hover:scale-105{% endif %} transition-transform">
                        {% if section_data.is_completed %}
                        <i class="fas fa-check text-white text-xl"></i>
                        {% elif section_data.is_accessible %}
                        <span class="text-white font-bold">{{ forloop.counter }}</span>
                        {% else %}
                        <i class="fas fa-lock text-white text-lg"></i>
                        {% endif %}
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold {% if section_data.is_accessible %}text-white group-hover:text-primary{% else %}text-gray-500{% endif %} transition-colors">
                            {% if LANGUAGE_CODE == 'fr' and section_data.section.title_fr %}
                                {{ section_data.section.title_fr }}
                            {% else %}
                                {{ section_data.section.title }}
                            {% endif %}
                        </h3>
                        <p class="text-gray-400 text-sm mt-1">
                            {% if section_data.is_completed %}
                                <i class="fas fa-check-circle text-success mr-1"></i>{% trans "Completed" %}
                            {% elif section_data.is_accessible %}
                                <i class="fas fa-play-circle mr-1"></i>{% trans "Start Learning" %}
                            {% else %}
                                <i class="fas fa-lock mr-1"></i>{% trans "Complete previous section" %}
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div>
                    {% if section_data.is_accessible %}
                    <a href="{% url 'section_detail' section_data.section.id %}" 
                       class="inline-flex items-center px-4 py-2 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors group-hover:scale-105">
                        {% if section_data.is_completed %}
                            <i class="fas fa-eye mr-2"></i>{% trans "Review" %}
                        {% else %}
                            <i class="fas fa-play mr-2"></i>{% trans "Start" %}
                        {% endif %}
                    </a>
                    {% else %}
                    <div class="inline-flex items-center px-4 py-2 bg-gray-600 text-gray-300 font-medium rounded-lg cursor-not-allowed">
                        <i class="fas fa-lock mr-2"></i>{% trans "Locked" %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="text-center py-16">
        <div class="w-24 h-24 bg-dark-card rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-book-open text-gray-500 text-3xl"></i>
        </div>
        <h3 class="text-2xl font-semibold text-gray-300 mb-4">{% trans "No Sections Available" %}</h3>
        <p class="text-gray-400 max-w-md mx-auto">{% trans "This room doesn't have any sections yet. Please check back later!" %}</p>
    </div>
    {% endif %}
</div>

<!-- Final Exam Section -->
{% if all_sections_completed %}
<div class="bg-dark-card border border-dark-border rounded-xl p-6 mb-8">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-white">
            <i class="fas fa-graduation-cap text-primary mr-2"></i>
            {% trans "Final Exam" %}
        </h2>
        {% if not user.can_access_quizzes %}
        <div class="inline-flex items-center px-3 py-1 bg-warning text-dark-bg rounded-lg text-sm">
            <i class="fas fa-lock mr-1"></i>
            Premium Required
        </div>
        {% endif %}
    </div>

    {% if user.can_access_quizzes %}
        {% if room_completion.is_completed %}
        <!-- Exam Completed -->
        <div class="text-center py-8">
            <div class="w-16 h-16 bg-success rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trophy text-white text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">{% trans "Congratulations!" %}</h3>
            <p class="text-gray-400 mb-4">{% trans "You've completed this room with a score of" %} {{ room_completion.final_exam_score }}%</p>
            <div class="flex items-center justify-center space-x-4">
                <a href="{% url 'download_certificate' room_completion.certificate.certificate_id %}" 
                   class="inline-flex items-center px-6 py-3 bg-success hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
                    <i class="fas fa-download mr-2"></i>
                    {% trans "Download Certificate" %}
                </a>
                <a href="{% url 'roadmap_detail' room.roadmap.id %}" 
                   class="inline-flex items-center px-6 py-3 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors">
                    <i class="fas fa-arrow-right mr-2"></i>
                    {% trans "Continue Learning" %}
                </a>
            </div>
        </div>
        {% else %}
        <!-- Exam Available -->
        <div class="text-center py-8">
            <div class="w-16 h-16 bg-warning rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-graduation-cap text-dark-bg text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">{% trans "Ready for Final Exam" %}</h3>
            <p class="text-gray-400 mb-6">{% trans "Test your knowledge with the final exam to complete this room and earn your certificate." %}</p>
            <div class="bg-dark-bg border border-dark-border rounded-lg p-4 mb-6">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <p class="text-2xl font-bold text-white">{{ final_exam_questions.count }}</p>
                        <p class="text-sm text-gray-400">{% trans "Questions" %}</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-white">70%</p>
                        <p class="text-sm text-gray-400">{% trans "Pass Rate" %}</p>
                    </div>
                </div>
            </div>
            <a href="{% url 'final_exam' room.id %}" 
               class="inline-flex items-center px-8 py-4 bg-warning hover:bg-yellow-600 text-dark-bg font-semibold rounded-lg transition-colors transform hover:scale-105">
                <i class="fas fa-play mr-2"></i>
                {% trans "Start Final Exam" %}
            </a>
        </div>
        {% endif %}
    {% else %}
    <!-- Premium Required -->
    <div class="text-center py-8">
        <div class="w-16 h-16 bg-warning rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-crown text-dark-bg text-2xl"></i>
        </div>
        <h3 class="text-xl font-semibold text-white mb-4">{% trans "Final exam requires a premium subscription." %}</h3>
        <p class="text-gray-400 mb-6">Upgrade to take the final exam and earn your completion certificate.</p>
        <a href="{% url 'upgrade_to_premium' %}" 
           class="inline-flex items-center px-6 py-3 bg-primary hover:bg-primary-dark text-white font-semibold rounded-lg transition-colors transform hover:scale-105">
            <i class="fas fa-star mr-2"></i>
            {% trans "Upgrade Now" %}
        </a>
    </div>
    {% endif %}
</div>
{% elif sections %}
<!-- Complete Sections First -->
<div class="bg-dark-card border border-dark-border rounded-xl p-6 mb-8">
    <div class="text-center py-8">
        <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-tasks text-white text-2xl"></i>
        </div>
        <h3 class="text-xl font-semibold text-white mb-2">{% trans "Complete All Sections" %}</h3>
        <p class="text-gray-400 mb-4">{% trans "Finish all sections to unlock the final exam." %}</p>
        <div class="w-64 h-3 bg-dark-bg rounded-full mx-auto">
            <div class="h-3 bg-primary rounded-full transition-all duration-500" style="width: {{ room_progress }}%"></div>
        </div>
        <p class="text-sm text-gray-400 mt-2">{{ completed_sections }}/{{ sections.count }} {% trans "sections completed" %}</p>
    </div>
</div>
{% endif %}

<!-- Navigation -->
<div class="bg-dark-card border border-dark-border rounded-xl p-6">
    <h3 class="text-lg font-semibold text-white mb-4">
        <i class="fas fa-compass text-primary mr-2"></i>
        {% trans "Navigation" %}
    </h3>
    <div class="flex items-center justify-between">
        <a href="{% url 'roadmap_detail' room.roadmap.id %}" 
           class="inline-flex items-center px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-lg transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            {% trans "Back to Roadmap" %}
        </a>

        {% if next_available_section %}
        <a href="{% url 'section_detail' next_available_section.id %}" 
           class="inline-flex items-center px-4 py-2 bg-primary hover:bg-primary-dark text-white font-medium rounded-lg transition-colors">
            {% trans "Continue Learning" %}
            <i class="fas fa-arrow-right ml-2"></i>
        </a>
        {% elif room_completion.is_completed %}
        <a href="{% url 'roadmap_detail' room.roadmap.id %}" 
           class="inline-flex items-center px-4 py-2 bg-success hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
            {% trans "Next Room" %}
            <i class="fas fa-arrow-right ml-2"></i>
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Animate progress bars on page load
    document.addEventListener('DOMContentLoaded', function() {
        const progressBars = document.querySelectorAll('[style*="width:"]');
        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
            }, 300);
        });

        // Add hover effects for section cards
        document.querySelectorAll('.group').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.classList.add('transform', 'scale-102');
            });
            card.addEventListener('mouseleave', function() {
                this.classList.remove('transform', 'scale-102');
            });
        });
    });
</script>
{% endblock %}